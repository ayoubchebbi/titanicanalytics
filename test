
public static void generateRecurrencePattern(List<MaintenancePlan> maintenancePlans) {
    for (MaintenancePlan maintenancePlan : maintenancePlans) {
        
        Map<String, String> frequencyMap = MaintenancePlanHelper.apiNameToFrequencyMap
            .get(maintenancePlan.OSMCO_VisitFrequency__c);
        
        String FREQ = 'WEEKLY';
        String INTERVAL = '1';
        String UNTIL = null;
        
        // Si frequencyMap existe, récupérer les valeurs
        if (frequencyMap != null) {
            if (frequencyMap.containsKey('FREQ')) {
                FREQ = frequencyMap.get('FREQ');
            }
            if (frequencyMap.containsKey('INTERVAL')) {
                INTERVAL = frequencyMap.get('INTERVAL');
            }
        }
        
        // Formater UNTIL depuis endDate si présent
        if (maintenancePlan.EndDate != null) {
            DateTime endDateTime = DateTime.newInstance(
                maintenancePlan.EndDate.year(),
                maintenancePlan.EndDate.month(),
                maintenancePlan.EndDate.day(),
                0, 0, 0
            );
            UNTIL = endDateTime.formatGMT('yyyyMMdd\'T\'HHmmss\'Z\'');
        }
        
        // Construire la chaîne RRULE
        String recurrencePattern = 'FREQ=' + FREQ + ';INTERVAL=' + INTERVAL;
        if (UNTIL != null) {
            recurrencePattern += ';UNTIL=' + UNTIL;
        }
        
        maintenancePlan.TEKCO_RecurrencePattern__c = recurrencePattern;
    }
}
