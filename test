public static void addDefaultSchedulingBookAppointment(List<ServiceAppointment> newServiceAppointments) {
    if (newServiceAppointments.isEmpty()) return;
    
    Set<String> lookupKeys = new Set<String>();
    Map<ServiceAppointment, String> appointmentToKey = new Map<ServiceAppointment, String>();
    
    // Single pass to build keys and relationships
    for (ServiceAppointment sa : newServiceAppointments) {
        String key = sa.TEKCO_Country__c + ':' + sa.TEKCO_Brand__c + ':true';
        lookupKeys.add(key);
        appointmentToKey.put(sa, key);
    }
    
    // Build policy lookup map
    Map<String, Id> policyMap = new Map<String, Id>();
    for (FSL_Scheduling_Policy__c sp : [
        SELECT Id, TEKCO_BookAppointmentCheck__c 
        FROM FSL_Scheduling_Policy__c 
        WHERE TEKCO_BookAppointmentCheck__c IN :lookupKeys
    ]) {
        policyMap.put(sp.TEKCO_BookAppointmentCheck__c, sp.Id);
    }
    
    // Apply mappings
    for (ServiceAppointment sa : appointmentToKey.keySet()) {
        Id policyId = policyMap.get(appointmentToKey.get(sa));
        if (policyId != null) {
            sa.TEKCO_defaultSchedulingBookAppointment__c = policyId;
        }
    }
}
